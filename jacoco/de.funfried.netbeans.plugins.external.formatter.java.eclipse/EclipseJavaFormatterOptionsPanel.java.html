<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EclipseJavaFormatterOptionsPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">External Java Code Formatters for NetBeans</a> &gt; <a href="index.source.html" class="el_package">de.funfried.netbeans.plugins.external.formatter.java.eclipse</a> &gt; <span class="el_source">EclipseJavaFormatterOptionsPanel.java</span></div><h1>EclipseJavaFormatterOptionsPanel.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2020 bahlef.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v2.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v20.html
 * Contributors:
 * bahlef - initial API and implementation and/or initial documentation
 */

package de.funfried.netbeans.plugins.external.formatter.java.eclipse;

import java.awt.Color;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.io.IOException;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.prefs.Preferences;

import javax.swing.DefaultComboBoxModel;
import javax.swing.GroupLayout;
import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JLabel;
import javax.swing.JTextField;
import javax.swing.LayoutStyle;
import javax.swing.SwingConstants;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import javax.swing.filechooser.FileFilter;
import javax.swing.filechooser.FileNameExtensionFilter;

import org.apache.commons.lang3.StringUtils;
import org.openide.awt.Mnemonics;
import org.openide.filesystems.FileChooserBuilder;
import org.openide.filesystems.FileObject;
import org.openide.util.NbBundle;
import org.xml.sax.SAXException;

import de.funfried.netbeans.plugins.external.formatter.exceptions.ConfigReadException;
import de.funfried.netbeans.plugins.external.formatter.java.eclipse.xml.ConfigReader;
import de.funfried.netbeans.plugins.external.formatter.ui.options.AbstractFormatterOptionsPanel;

/**
 *
 * @author bahlef
 */
public class EclipseJavaFormatterOptionsPanel extends AbstractFormatterOptionsPanel {
	/** {@link Logger} of this class. */
<span class="nc" id="L54">	private static final Logger log = Logger.getLogger(EclipseJavaFormatterOptionsPanel.class.getName());</span>

	/** Flag which holds the active flag information. */
<span class="nc" id="L57">	private boolean active = false;</span>

	/** Creates new form EclipseJavaFormatterOptionsPanel. */
<span class="nc" id="L60">	public EclipseJavaFormatterOptionsPanel() {</span>
<span class="nc" id="L61">		initComponents();</span>
<span class="nc" id="L62">	}</span>

	/**
	 * This method is called from within the constructor to
	 * initialize the form.
	 * WARNING: Do NOT modify this code. The content of this method is
	 * always regenerated by the Form Editor.
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
    // &lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;Generated Code&quot;&gt;//GEN-BEGIN:initComponents
    private void initComponents() {

<span class="nc" id="L74">        lblFormatterFile = new JLabel();</span>
<span class="nc" id="L75">        formatterLocField = new JTextField();</span>
<span class="nc" id="L76">        browseButton = new JButton();</span>
<span class="nc" id="L77">        errorLabel = new JLabel();</span>
<span class="nc" id="L78">        jLabel2 = new JLabel();</span>
<span class="nc" id="L79">        cbProfile = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L80">        lblProfile = new JLabel();</span>
<span class="nc" id="L81">        cbUseProjectPref = new JCheckBox();</span>
<span class="nc" id="L82">        lblLinefeed = new JLabel();</span>
<span class="nc" id="L83">        cbLinefeed = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L84">        lblSourceLevel = new JLabel();</span>
<span class="nc" id="L85">        cbSourceLevel = new JComboBox&lt;&gt;();</span>

<span class="nc" id="L87">        lblFormatterFile.setHorizontalAlignment(SwingConstants.RIGHT);</span>
<span class="nc" id="L88">        Mnemonics.setLocalizedText(lblFormatterFile, NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.lblFormatterFile.text&quot;)); // NOI18N</span>
<span class="nc" id="L89">        lblFormatterFile.setToolTipText(NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.lblFormatterFile.toolTipText&quot;)); // NOI18N</span>

<span class="nc" id="L91">        formatterLocField.setText(NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.formatterLocField.text&quot;)); // NOI18N</span>
<span class="nc" id="L92">        formatterLocField.addActionListener(new ActionListener() {</span>
            public void actionPerformed(ActionEvent evt) {
<span class="nc" id="L94">                formatterLocFieldActionPerformed(evt);</span>
<span class="nc" id="L95">            }</span>
        });

<span class="nc" id="L98">        Mnemonics.setLocalizedText(browseButton, NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.browseButton.text&quot;)); // NOI18N</span>
<span class="nc" id="L99">        browseButton.setToolTipText(NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.browseButton.toolTipText&quot;)); // NOI18N</span>
<span class="nc" id="L100">        browseButton.addActionListener(new ActionListener() {</span>
            public void actionPerformed(ActionEvent evt) {
<span class="nc" id="L102">                browseButtonActionPerformed(evt);</span>
<span class="nc" id="L103">            }</span>
        });

<span class="nc" id="L106">        errorLabel.setForeground(new Color(255, 51, 51));</span>
<span class="nc" id="L107">        Mnemonics.setLocalizedText(errorLabel, NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.errorLabel.text&quot;)); // NOI18N</span>
<span class="nc" id="L108">        errorLabel.setToolTipText(NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.errorLabel.toolTipText&quot;)); // NOI18N</span>

<span class="nc" id="L110">        Mnemonics.setLocalizedText(jLabel2, NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.jLabel2.text&quot;)); // NOI18N</span>
<span class="nc" id="L111">        jLabel2.setEnabled(false);</span>

<span class="nc" id="L113">        cbProfile.setToolTipText(NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.cbProfile.toolTipText&quot;)); // NOI18N</span>
<span class="nc" id="L114">        cbProfile.addActionListener(new ActionListener() {</span>
            public void actionPerformed(ActionEvent evt) {
<span class="nc" id="L116">                cbProfileActionPerformed(evt);</span>
<span class="nc" id="L117">            }</span>
        });

<span class="nc" id="L120">        lblProfile.setHorizontalAlignment(SwingConstants.RIGHT);</span>
<span class="nc" id="L121">        Mnemonics.setLocalizedText(lblProfile, NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.lblProfile.text&quot;)); // NOI18N</span>

<span class="nc" id="L123">        Mnemonics.setLocalizedText(cbUseProjectPref, NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.cbUseProjectPref.text&quot;)); // NOI18N</span>
<span class="nc" id="L124">        cbUseProjectPref.setToolTipText(NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.cbUseProjectPref.toolTipText&quot;)); // NOI18N</span>

<span class="nc" id="L126">        lblLinefeed.setHorizontalAlignment(SwingConstants.RIGHT);</span>
<span class="nc" id="L127">        Mnemonics.setLocalizedText(lblLinefeed, NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.lblLinefeed.text&quot;)); // NOI18N</span>
<span class="nc" id="L128">        lblLinefeed.setToolTipText(NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.lblLinefeed.toolTipText&quot;)); // NOI18N</span>

<span class="nc" id="L130">        cbLinefeed.setModel(new DefaultComboBoxModel&lt;&gt;(new String[] { &quot;System&quot;, &quot;\\n&quot;, &quot;\\r\\n&quot;, &quot;\\r&quot; }));</span>
<span class="nc" id="L131">        cbLinefeed.setToolTipText(NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.cbLinefeed.toolTipText&quot;)); // NOI18N</span>
<span class="nc" id="L132">        cbLinefeed.addActionListener(new ActionListener() {</span>
            public void actionPerformed(ActionEvent evt) {
<span class="nc" id="L134">                cbLinefeedActionPerformed(evt);</span>
<span class="nc" id="L135">            }</span>
        });

<span class="nc" id="L138">        Mnemonics.setLocalizedText(lblSourceLevel, NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.lblSourceLevel.text&quot;)); // NOI18N</span>

<span class="nc" id="L140">        cbSourceLevel.setModel(new DefaultComboBoxModel&lt;&gt;(new String[] { &quot;No override&quot;, &quot;1.9&quot;, &quot;1.8&quot;, &quot;1.7&quot;, &quot;1.6&quot;, &quot;1.5&quot;, &quot;1.4&quot; }));</span>
<span class="nc" id="L141">        cbSourceLevel.setToolTipText(NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.cbSourceLevel.toolTipText&quot;)); // NOI18N</span>
<span class="nc" id="L142">        cbSourceLevel.addActionListener(new ActionListener() {</span>
            public void actionPerformed(ActionEvent evt) {
<span class="nc" id="L144">                cbSourceLevelActionPerformed(evt);</span>
<span class="nc" id="L145">            }</span>
        });

<span class="nc" id="L148">        GroupLayout layout = new GroupLayout(this);</span>
<span class="nc" id="L149">        this.setLayout(layout);</span>
<span class="nc" id="L150">        layout.setHorizontalGroup(layout.createParallelGroup(GroupLayout.Alignment.LEADING)</span>
<span class="nc" id="L151">            .addGroup(layout.createSequentialGroup()</span>
<span class="nc" id="L152">                .addContainerGap()</span>
<span class="nc" id="L153">                .addGroup(layout.createParallelGroup(GroupLayout.Alignment.TRAILING)</span>
<span class="nc" id="L154">                    .addComponent(lblFormatterFile)</span>
<span class="nc" id="L155">                    .addComponent(lblProfile, GroupLayout.PREFERRED_SIZE, 110, GroupLayout.PREFERRED_SIZE)</span>
<span class="nc" id="L156">                    .addComponent(lblLinefeed, GroupLayout.PREFERRED_SIZE, 110, GroupLayout.PREFERRED_SIZE))</span>
<span class="nc" id="L157">                .addPreferredGap(LayoutStyle.ComponentPlacement.UNRELATED)</span>
<span class="nc" id="L158">                .addGroup(layout.createParallelGroup(GroupLayout.Alignment.LEADING)</span>
<span class="nc" id="L159">                    .addGroup(layout.createSequentialGroup()</span>
<span class="nc" id="L160">                        .addComponent(formatterLocField)</span>
<span class="nc" id="L161">                        .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)</span>
<span class="nc" id="L162">                        .addComponent(browseButton))</span>
<span class="nc" id="L163">                    .addGroup(layout.createSequentialGroup()</span>
<span class="nc" id="L164">                        .addGroup(layout.createParallelGroup(GroupLayout.Alignment.LEADING)</span>
<span class="nc" id="L165">                            .addGroup(layout.createSequentialGroup()</span>
<span class="nc" id="L166">                                .addComponent(cbLinefeed, GroupLayout.PREFERRED_SIZE, 121, GroupLayout.PREFERRED_SIZE)</span>
<span class="nc" id="L167">                                .addGap(18, 18, 18)</span>
<span class="nc" id="L168">                                .addComponent(lblSourceLevel)</span>
<span class="nc" id="L169">                                .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)</span>
<span class="nc" id="L170">                                .addComponent(cbSourceLevel, GroupLayout.PREFERRED_SIZE, 121, GroupLayout.PREFERRED_SIZE))</span>
<span class="nc" id="L171">                            .addComponent(cbUseProjectPref)</span>
<span class="nc" id="L172">                            .addComponent(cbProfile, GroupLayout.PREFERRED_SIZE, 200, GroupLayout.PREFERRED_SIZE))</span>
<span class="nc" id="L173">                        .addGap(0, 0, Short.MAX_VALUE))</span>
<span class="nc" id="L174">                    .addGroup(layout.createSequentialGroup()</span>
<span class="nc" id="L175">                        .addComponent(jLabel2, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE)</span>
<span class="nc" id="L176">                        .addPreferredGap(LayoutStyle.ComponentPlacement.UNRELATED)</span>
<span class="nc" id="L177">                        .addComponent(errorLabel, GroupLayout.DEFAULT_SIZE, GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))</span>
<span class="nc" id="L178">                .addContainerGap())</span>
        );
<span class="nc" id="L180">        layout.setVerticalGroup(layout.createParallelGroup(GroupLayout.Alignment.LEADING)</span>
<span class="nc" id="L181">            .addGroup(layout.createSequentialGroup()</span>
<span class="nc" id="L182">                .addContainerGap()</span>
<span class="nc" id="L183">                .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)</span>
<span class="nc" id="L184">                    .addComponent(lblFormatterFile)</span>
<span class="nc" id="L185">                    .addComponent(formatterLocField, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE)</span>
<span class="nc" id="L186">                    .addComponent(browseButton))</span>
<span class="nc" id="L187">                .addGap(7, 7, 7)</span>
<span class="nc" id="L188">                .addGroup(layout.createParallelGroup(GroupLayout.Alignment.LEADING)</span>
<span class="nc" id="L189">                    .addComponent(errorLabel, GroupLayout.PREFERRED_SIZE, 26, GroupLayout.PREFERRED_SIZE)</span>
<span class="nc" id="L190">                    .addComponent(jLabel2, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE))</span>
<span class="nc" id="L191">                .addPreferredGap(LayoutStyle.ComponentPlacement.RELATED)</span>
<span class="nc" id="L192">                .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)</span>
<span class="nc" id="L193">                    .addComponent(cbProfile, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE)</span>
<span class="nc" id="L194">                    .addComponent(lblProfile))</span>
<span class="nc" id="L195">                .addPreferredGap(LayoutStyle.ComponentPlacement.UNRELATED)</span>
<span class="nc" id="L196">                .addComponent(cbUseProjectPref)</span>
<span class="nc" id="L197">                .addPreferredGap(LayoutStyle.ComponentPlacement.UNRELATED)</span>
<span class="nc" id="L198">                .addGroup(layout.createParallelGroup(GroupLayout.Alignment.BASELINE)</span>
<span class="nc" id="L199">                    .addComponent(cbLinefeed, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE)</span>
<span class="nc" id="L200">                    .addComponent(lblLinefeed)</span>
<span class="nc" id="L201">                    .addComponent(lblSourceLevel)</span>
<span class="nc" id="L202">                    .addComponent(cbSourceLevel, GroupLayout.PREFERRED_SIZE, GroupLayout.DEFAULT_SIZE, GroupLayout.PREFERRED_SIZE))</span>
<span class="nc" id="L203">                .addContainerGap(GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))</span>
        );

<span class="nc" id="L206">        formatterLocField.getDocument().addDocumentListener(new DocumentListener() {</span>
            /**
            * {@inheritDoc}
            */
            @Override
            public void insertUpdate(DocumentEvent e) {
<span class="nc" id="L212">                fireChangedListener();</span>
<span class="nc" id="L213">            }</span>

            /**
            * {@inheritDoc}
            */
            @Override
            public void removeUpdate(DocumentEvent e) {
<span class="nc" id="L220">                fireChangedListener();</span>
<span class="nc" id="L221">            }</span>

            /**
            * {@inheritDoc}
            */
            @Override
            public void changedUpdate(DocumentEvent e) {
<span class="nc" id="L228">                fireChangedListener();</span>
<span class="nc" id="L229">            }</span>
        });
<span class="nc" id="L231">    }// &lt;/editor-fold&gt;//GEN-END:initComponents</span>

    private void formatterLocFieldActionPerformed(ActionEvent evt) {//GEN-FIRST:event_formatterLocFieldActionPerformed
<span class="nc" id="L234">        loadEclipseFormatterFileForPreview(formatterLocField.getText(), getSelectedProfile());</span>
<span class="nc" id="L235">        fireChangedListener();</span>
<span class="nc" id="L236">    }//GEN-LAST:event_formatterLocFieldActionPerformed</span>

    private void browseButtonActionPerformed(ActionEvent evt) {//GEN-FIRST:event_browseButtonActionPerformed
        //The default dir to use if no value is stored
<span class="nc" id="L240">        File home = new File(System.getProperty(&quot;user.home&quot;));</span>
<span class="nc" id="L241">        final FileNameExtensionFilter fileNameExtensionFilterXML = new FileNameExtensionFilter(&quot;Eclipse formatter (*.xml)&quot;, &quot;xml&quot;);</span>
<span class="nc" id="L242">        final FileNameExtensionFilter fileNameExtensionFilterEPF = new FileNameExtensionFilter(&quot;Workspace mechanic (*.epf)&quot;, &quot;epf&quot;);</span>
<span class="nc" id="L243">        final FileFilter fileNameExtensionFilterProjectSetting = new FileFilter() {</span>
            /**
            * {@inheritDoc}
            */
            @Override
            public boolean accept(File f) {
<span class="nc bnc" id="L249" title="All 2 branches missed.">                if (f.isDirectory()) {</span>
<span class="nc" id="L250">                    return true;</span>
                }
<span class="nc" id="L252">                return EclipseJavaFormatterSettings.PROJECT_PREF_FILE.equals(f.getName());</span>
            }

            /**
            * {@inheritDoc}
            */
            @Override
            public String getDescription() {
<span class="nc" id="L260">                return &quot;Eclipse project settings (&quot; + EclipseJavaFormatterSettings.PROJECT_PREF_FILE + &quot;)&quot;;</span>
            }
        };
        //Now build a file chooser and invoke the dialog in one line of code
        //&quot;user-dir&quot; is our unique key
<span class="nc" id="L265">        File toAdd = new FileChooserBuilder(&quot;user-dir&quot;).setFileHiding(false).setFilesOnly(true).setTitle(&quot;Choose configuration ...&quot;).setDefaultWorkingDirectory(home).setApproveText(&quot;Choose&quot;)</span>
<span class="nc" id="L266">        .addFileFilter(fileNameExtensionFilterProjectSetting).addFileFilter(fileNameExtensionFilterXML).addFileFilter(fileNameExtensionFilterEPF).setFileFilter(fileNameExtensionFilterXML)</span>
<span class="nc" id="L267">        .showOpenDialog();</span>
        //Result will be null if the user clicked cancel or closed the dialog w/o OK
<span class="nc bnc" id="L269" title="All 2 branches missed.">        if (toAdd != null) {</span>
<span class="nc" id="L270">            loadEclipseFormatterFileForPreview(toAdd.getAbsolutePath(), getSelectedProfile());</span>
        }
<span class="nc" id="L272">    }//GEN-LAST:event_browseButtonActionPerformed</span>

    private void cbProfileActionPerformed(ActionEvent evt) {//GEN-FIRST:event_cbProfileActionPerformed
<span class="nc" id="L275">        fireChangedListener();</span>
<span class="nc" id="L276">    }//GEN-LAST:event_cbProfileActionPerformed</span>

    private void cbLinefeedActionPerformed(ActionEvent evt) {//GEN-FIRST:event_cbLinefeedActionPerformed
<span class="nc" id="L279">        fireChangedListener();</span>
<span class="nc" id="L280">    }//GEN-LAST:event_cbLinefeedActionPerformed</span>

    private void cbSourceLevelActionPerformed(ActionEvent evt) {//GEN-FIRST:event_cbSourceLevelActionPerformed
<span class="nc" id="L283">        fireChangedListener();</span>
<span class="nc" id="L284">    }//GEN-LAST:event_cbSourceLevelActionPerformed</span>

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private JButton browseButton;
    private JComboBox&lt;String&gt; cbLinefeed;
    private JComboBox&lt;String&gt; cbProfile;
    private JComboBox&lt;String&gt; cbSourceLevel;
    private JCheckBox cbUseProjectPref;
    private JLabel errorLabel;
    private JTextField formatterLocField;
    private JLabel jLabel2;
    private JLabel lblFormatterFile;
    private JLabel lblLinefeed;
    private JLabel lblProfile;
    private JLabel lblSourceLevel;
    // End of variables declaration//GEN-END:variables

	private String getLinefeed() {
<span class="nc bnc" id="L302" title="All 2 branches missed.">		if (0 == cbLinefeed.getSelectedIndex()) {</span>
<span class="nc" id="L303">			return &quot;&quot;;</span>
		}
<span class="nc" id="L305">		return cbLinefeed.getSelectedItem().toString();</span>
	}

	/**
	 * Returns the selected Eclipse formatter profile.
	 *
	 * @return the selected Eclipse formatter profile
	 */
	private String getSelectedProfile() {
<span class="nc bnc" id="L314" title="All 2 branches missed.">		if (null != cbProfile.getSelectedItem()) {</span>
<span class="nc" id="L315">			return cbProfile.getSelectedItem().toString();</span>
		} else {
<span class="nc" id="L317">			return &quot;&quot;;</span>
		}
	}

	private String getSourceLevel() {
<span class="nc bnc" id="L322" title="All 2 branches missed.">		if (cbSourceLevel.getSelectedIndex() &gt;= 1) {</span>
<span class="nc" id="L323">			return &quot;&quot; + cbSourceLevel.getSelectedItem();</span>
		} else {
<span class="nc" id="L325">			return &quot;&quot;;</span>
		}
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void load(Preferences preferences) {
<span class="nc" id="L334">		String eclipseFormatterLocation = preferences.get(EclipseJavaFormatterSettings.ECLIPSE_FORMATTER_CONFIG_FILE_LOCATION, &quot;&quot;);</span>
<span class="nc" id="L335">		String eclipseFormatterProfile = preferences.get(EclipseJavaFormatterSettings.ECLIPSE_FORMATTER_ACTIVE_PROFILE, &quot;&quot;);</span>
<span class="nc" id="L336">		boolean useProjectPrefs = preferences.getBoolean(EclipseJavaFormatterSettings.USE_PROJECT_PREFS, true);</span>
<span class="nc" id="L337">		String eclipseLineFeed = preferences.get(EclipseJavaFormatterSettings.LINEFEED, &quot;&quot;);</span>
<span class="nc" id="L338">		String sourceLevel = preferences.get(EclipseJavaFormatterSettings.SOURCELEVEL, &quot;&quot;);</span>

<span class="nc" id="L340">		loadEclipseFormatterFileForPreview(eclipseFormatterLocation, eclipseFormatterProfile);</span>

<span class="nc" id="L342">		cbUseProjectPref.setSelected(useProjectPrefs);</span>

<span class="nc bnc" id="L344" title="All 2 branches missed.">		if (StringUtils.isBlank(eclipseLineFeed)) {</span>
			//default = system-dependend LF
<span class="nc" id="L346">			cbLinefeed.setSelectedIndex(0);</span>
		} else {
<span class="nc" id="L348">			cbLinefeed.setSelectedItem(eclipseLineFeed);</span>
		}

<span class="nc bnc" id="L351" title="All 2 branches missed.">		if (StringUtils.isBlank(sourceLevel)) {</span>
			//default = No override
<span class="nc" id="L353">			cbSourceLevel.setSelectedIndex(0);</span>
		} else {
<span class="nc" id="L355">			cbSourceLevel.setSelectedItem(sourceLevel);</span>
		}

<span class="nc" id="L358">		updateEnabledState();</span>
<span class="nc" id="L359">	}</span>

	private void loadEclipseFormatterFileForPreview(String formatterFile, String activeProfile) {
<span class="nc" id="L362">		formatterLocField.setText(formatterFile);</span>
<span class="nc" id="L363">		final File file = new File(formatterFile);</span>

<span class="nc" id="L365">		cbProfile.setEnabled(false);</span>
<span class="nc" id="L366">		lblProfile.setEnabled(false);</span>

<span class="nc" id="L368">		cbProfile.removeAllItems();</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">		if (file.exists()) {</span>
			try {
<span class="nc" id="L371">				final FileObject fo = ConfigReader.toFileObject(file);</span>

				//only xml configurations contain profiles
<span class="nc bnc" id="L374" title="All 2 branches missed.">				if (EclipseJavaFormatterSettings.isXMLConfigurationFile(fo.getNameExt())) {</span>
<span class="nc" id="L375">					List&lt;String&gt; profileNames = ConfigReader.getProfileNames(fo);</span>
<span class="nc" id="L376">					cbProfile.addItem(NbBundle.getMessage(EclipseJavaFormatterOptionsPanel.class, &quot;EclipseJavaFormatterOptionsPanel.chooseProfile&quot;));</span>

<span class="nc" id="L378">					String entryToSelect = null;</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">					for (String profileName : profileNames) {</span>
<span class="nc" id="L380">						cbProfile.addItem(profileName);</span>
<span class="nc bnc" id="L381" title="All 4 branches missed.">						if (activeProfile != null &amp;&amp; activeProfile.equals(profileName)) {</span>
<span class="nc" id="L382">							entryToSelect = profileName;</span>
						}
<span class="nc" id="L384">					}</span>
<span class="nc" id="L385">					selectProfileOrFallback(entryToSelect, profileNames);</span>
<span class="nc" id="L386">					cbProfile.setEnabled(true);</span>
<span class="nc" id="L387">					lblProfile.setEnabled(true);</span>
				}
<span class="nc" id="L389">			} catch (IOException | SAXException | ConfigReadException ex) {</span>
<span class="nc" id="L390">				log.log(Level.WARNING, &quot;Could not parse formatter config&quot;, ex);</span>
<span class="nc" id="L391">			}</span>
		}
<span class="nc" id="L393">	}</span>

	private void selectProfileOrFallback(String entryToSelect, List&lt;String&gt; profiles) {
<span class="nc bnc" id="L396" title="All 2 branches missed.">		if (null != entryToSelect) {</span>
<span class="nc" id="L397">			cbProfile.setSelectedItem(entryToSelect);</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">		} else if (profiles.size() == 1) {</span>
			//only one entry (excl. default) -&gt; choose the only valid item
<span class="nc" id="L400">			cbProfile.setSelectedIndex(1);</span>
		} else {
			//fallback: ===choose profile==
<span class="nc" id="L403">			cbProfile.setSelectedIndex(0);</span>
		}
<span class="nc" id="L405">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void setActive(boolean active) {
<span class="nc" id="L412">		this.active = active;</span>

<span class="nc" id="L414">		updateEnabledState();</span>
<span class="nc" id="L415">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void store(Preferences preferences) {
<span class="nc" id="L422">		preferences.put(EclipseJavaFormatterSettings.ECLIPSE_FORMATTER_CONFIG_FILE_LOCATION, formatterLocField.getText());</span>
<span class="nc" id="L423">		preferences.put(EclipseJavaFormatterSettings.ECLIPSE_FORMATTER_ACTIVE_PROFILE, getSelectedProfile());</span>
<span class="nc" id="L424">		preferences.putBoolean(EclipseJavaFormatterSettings.USE_PROJECT_PREFS, cbUseProjectPref.isSelected());</span>
<span class="nc" id="L425">		preferences.put(EclipseJavaFormatterSettings.LINEFEED, getLinefeed());</span>
<span class="nc" id="L426">		preferences.put(EclipseJavaFormatterSettings.SOURCELEVEL, getSourceLevel());</span>
<span class="nc" id="L427">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public boolean valid() {
<span class="nc" id="L434">		errorLabel.setText(&quot;&quot;);</span>

		// use configuration from .settings
<span class="nc bnc" id="L437" title="All 2 branches missed.">		if (cbUseProjectPref.isSelected()) {</span>
<span class="nc" id="L438">			return true;</span>
		}

<span class="nc" id="L441">		String fileName = formatterLocField.getText();</span>
<span class="nc" id="L442">		boolean isXML = EclipseJavaFormatterSettings.isXMLConfigurationFile(fileName);</span>
<span class="nc bnc" id="L443" title="All 4 branches missed.">		if (isXML &amp;&amp; cbProfile.getSelectedIndex() == 0) {</span>
			// &quot;choose profile&quot; entry is selected
<span class="nc" id="L445">			return false;</span>
		}

<span class="nc" id="L448">		boolean isEPF = EclipseJavaFormatterSettings.isWorkspaceMechanicFile(fileName);</span>
<span class="nc" id="L449">		boolean isProjectSetting = EclipseJavaFormatterSettings.isProjectSetting(fileName);</span>

<span class="nc bnc" id="L451" title="All 8 branches missed.">		if (new File(fileName).exists() &amp;&amp; (isXML || isEPF || isProjectSetting)) {</span>
<span class="nc" id="L452">			return true;</span>
		} else {
<span class="nc" id="L454">			errorLabel.setText(&quot;Invalid file. Please enter a valid configuration file.&quot;);</span>
<span class="nc" id="L455">			return false;</span>
		}
	}

	private void updateEnabledState() {
<span class="nc" id="L460">		lblFormatterFile.setEnabled(this.active);</span>
<span class="nc" id="L461">		browseButton.setEnabled(this.active);</span>
<span class="nc" id="L462">		formatterLocField.setEnabled(this.active);</span>

<span class="nc bnc" id="L464" title="All 2 branches missed.">		if (cbProfile.getSelectedIndex() != -1) {</span>
<span class="nc" id="L465">			lblProfile.setEnabled(this.active);</span>
<span class="nc" id="L466">			cbProfile.setEnabled(this.active);</span>
		} else {
<span class="nc" id="L468">			lblProfile.setEnabled(false);</span>
<span class="nc" id="L469">			cbProfile.setEnabled(false);</span>
		}

<span class="nc" id="L472">		cbUseProjectPref.setEnabled(this.active);</span>
<span class="nc" id="L473">		cbLinefeed.setEnabled(this.active);</span>
<span class="nc" id="L474">		lblLinefeed.setEnabled(this.active);</span>
<span class="nc" id="L475">		cbSourceLevel.setEnabled(this.active);</span>
<span class="nc" id="L476">		lblSourceLevel.setEnabled(this.active);</span>
<span class="nc" id="L477">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>